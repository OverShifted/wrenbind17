<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Liveness and garbage collection | Wren Bind c++17</title>
    <meta name="description" content="Wren language binding library for C++17">
    
    
    <link rel="preload" href="/wrenbind17/assets/css/0.styles.81e95383.css" as="style"><link rel="preload" href="/wrenbind17/assets/js/app.e6ecd826.js" as="script"><link rel="preload" href="/wrenbind17/assets/js/2.8d7926a2.js" as="script"><link rel="preload" href="/wrenbind17/assets/js/13.67b5eb9e.js" as="script"><link rel="prefetch" href="/wrenbind17/assets/js/10.0b58e701.js"><link rel="prefetch" href="/wrenbind17/assets/js/11.30fc4ffe.js"><link rel="prefetch" href="/wrenbind17/assets/js/12.29ea8eab.js"><link rel="prefetch" href="/wrenbind17/assets/js/14.513db919.js"><link rel="prefetch" href="/wrenbind17/assets/js/15.bd6938d9.js"><link rel="prefetch" href="/wrenbind17/assets/js/16.4b3ec8c6.js"><link rel="prefetch" href="/wrenbind17/assets/js/3.8fb6d65f.js"><link rel="prefetch" href="/wrenbind17/assets/js/4.0c63175a.js"><link rel="prefetch" href="/wrenbind17/assets/js/5.a4bf3ff4.js"><link rel="prefetch" href="/wrenbind17/assets/js/6.351e486f.js"><link rel="prefetch" href="/wrenbind17/assets/js/7.3e313d7e.js"><link rel="prefetch" href="/wrenbind17/assets/js/8.d21a7244.js"><link rel="prefetch" href="/wrenbind17/assets/js/9.cec8846a.js">
    <link rel="stylesheet" href="/wrenbind17/assets/css/0.styles.81e95383.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wrenbind17/" class="home-link router-link-active"><!----> <span class="site-name">Wren Bind c++17</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wrenbind17/" class="nav-link">Home</a></div><div class="nav-item"><a href="/wrenbind17/docs/tutorial.html" class="nav-link">Tutorial</a></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/modules.html" class="nav-link">Modules</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Classes</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/annotated.html" class="nav-link">Class List</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/classes.html" class="nav-link">Class Index</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/hierarchy.html" class="nav-link">Class Hierarchy</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_members.html" class="nav-link">Class Members</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_functions.html" class="nav-link">Class Member Functions</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_variables.html" class="nav-link">Class Member Variables</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_typedefs.html" class="nav-link">Class Member Typedefs</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_enums.html" class="nav-link">Class Member Enumerations</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Namespaces</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespaces.html" class="nav-link">Namespace List</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_members.html" class="nav-link">Namespace Members</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_functions.html" class="nav-link">Namespace Member Functions</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_variables.html" class="nav-link">Namespace Member Variables</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_typedefs.html" class="nav-link">Namespace Member Typedefs</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_enums.html" class="nav-link">Namespace Member Enumerations</a></li></ul></div></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/files.html" class="nav-link">Files</a></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/pages.html" class="nav-link">Pages</a></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/bug.html" class="nav-link">Bugs</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wrenbind17/" class="nav-link">Home</a></div><div class="nav-item"><a href="/wrenbind17/docs/tutorial.html" class="nav-link">Tutorial</a></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/modules.html" class="nav-link">Modules</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Classes</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/annotated.html" class="nav-link">Class List</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/classes.html" class="nav-link">Class Index</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/hierarchy.html" class="nav-link">Class Hierarchy</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_members.html" class="nav-link">Class Members</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_functions.html" class="nav-link">Class Member Functions</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_variables.html" class="nav-link">Class Member Variables</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_typedefs.html" class="nav-link">Class Member Typedefs</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/class_member_enums.html" class="nav-link">Class Member Enumerations</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Namespaces</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespaces.html" class="nav-link">Namespace List</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_members.html" class="nav-link">Namespace Members</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_functions.html" class="nav-link">Namespace Member Functions</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_variables.html" class="nav-link">Namespace Member Variables</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_typedefs.html" class="nav-link">Namespace Member Typedefs</a></li><li class="dropdown-item"><!----> <a href="/wrenbind17/docs/doxygen/namespace_member_enums.html" class="nav-link">Namespace Member Enumerations</a></li></ul></div></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/files.html" class="nav-link">Files</a></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/pages.html" class="nav-link">Pages</a></div><div class="nav-item"><a href="/wrenbind17/docs/doxygen/bug.html" class="nav-link">Bugs</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Liveness and garbage collection</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/wrenbind17/docs/liveness_garbage.html#who-manages-the-memory" class="sidebar-link">Who manages the memory?</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/wrenbind17/docs/liveness_garbage.html#how-do-i" class="sidebar-link">How do I...</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/wrenbind17/docs/liveness_garbage.html#return-values" class="sidebar-link">Return values</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/wrenbind17/docs/liveness_garbage.html#why-this-design" class="sidebar-link">Why this design?</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="liveness-and-garbage-collection"><a href="#liveness-and-garbage-collection" aria-hidden="true" class="header-anchor">#</a> Liveness and garbage collection</h1> <h2 id="who-manages-the-memory"><a href="#who-manages-the-memory" aria-hidden="true" class="header-anchor">#</a> Who manages the memory?</h2> <p>This library is meant to be stupid simple. There is no explicit memory management, and instead it follows this formula:</p> <p>If you create an instance of class on C++, the C++ controls the liveness of the instance. If you pass it into the Wren, it will not be freed by the garbage collector.</p> <p>If you create an instance of class on Wren, let's say a foreign C++ class, the Wren controls the liveness of the instance. But, if you call Wren function and you will get the shared pointer of that instance, you will extend the liveness of that instance via the shared_ptr.</p> <p>This is because all class instances are wrapped in a <code>ForeignObject&lt;T&gt;</code> class and put into Wren's foreign handle. This wrapper consists of a <code>shared_ptr&lt;T&gt;</code>. So, every C++ instance is wrapped into <code>shared_ptr&lt;T&gt;</code>. But, it works in the following way:</p> <ul><li>You call Wren function and pass C++ instance as a value (no reference, no pointer). The value will be copied into a new instance and put into <code>shared_ptr&lt;T&gt;</code>. The copy will be freed when Wren garbage collects it. But you can extend the liveness if you get <code>shared_ptr&lt;T&gt;</code> of it (by calling Wren method and returning the instance).</li> <li>You call Wren function and pass C++ instance as a reference. The reference will be handled as a pointer, and will be put into <code>shared_ptr&lt;T&gt;</code> with no deletion. It will not be deleted when Wren harbage collects this instance on Wren side.</li> <li>You call Wren function and pass C++ instance as a pointer. Same scenario with reference, it will be put into <code>shared_ptr&lt;T&gt;</code> with no deletion.</li> <li>You call Wren function and pass C++ instance as a shared pointer. The liveness will depend on the shared pointer. No extra <code>shared_ptr&lt;T&gt;</code> will be created, the wrapper will use the shared pointer you have given it.</li> <li>You call Wren function and get the return value as a C++ instance. Then read below [Return values](#Return values) section.</li></ul> <h2 id="how-do-i"><a href="#how-do-i" aria-hidden="true" class="header-anchor">#</a> How do I...</h2> <ul><li>I want C++ to control liveness -&gt; Pass it to Wren as a pointer or a reference.</li> <li>I want Wren to control liveness -&gt; Create the instance on Wren.</li> <li>I want both C++ and Wren to control liveness -&gt; Create the instance on Wren and return it to C++ as a shared pointer. Or create the instance on C++ and pass it to Wren as a shared pointer.</li> <li>I want C++ to take over the liveness -&gt; Not possible.</li> <li>I want Wren to take over the liveness -&gt; Not possible.</li></ul> <h2 id="return-values"><a href="#return-values" aria-hidden="true" class="header-anchor">#</a> Return values</h2> <p>Everything in Wren is garbage collected, and we have no control over that on the C++ side. When you call a Wren function and return a simple type (integer, float, string, boolean, nullptr) it will automatically create a copy on C++ side inside of the <code>wren::ReturnValue</code>. You don't have to worry that an integer will get deleted or something. That would be stupid.</p> <p>But it gets bit tricky when using C++ classes that you have manually added to Wren. When you return such class, the return value is actually a handle. This handle can be considered as a special pointer inside of Wren. If you get the class as a copy (by calling <code>as&lt;T&gt;()</code>), there is no problem. If you get the class as a pointer, the liveliness of the instance depends on the handle (and garbage collection). If you continue using the pointer outside of the scope of the <code>wren::ReturnValue</code> you will definitely get into segementation fault. This can be avoided by getting the class as <code>res.shared&lt;T&gt;()</code>. This will give you a shared_ptr which is held inside of the Wren handle. This won't create duplicates. The instance will continue to live until the <code>wren::ReturnValue</code> has falled out of the scope, all of the <code>shared_ptr&lt;T&gt;</code> are destroyed, and the variable on Wren is garbage collected.</p> <p>Example of what not to do:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">&quot;mymodule&quot;</span> <span class="token keyword">for</span> CppClass

<span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> CppClass<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And C++ code:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> CppClass<span class="token operator">*</span> <span class="token function">getMyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wren<span class="token operator">::</span>Method baz <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token string">&quot;baz()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wren<span class="token operator">::</span>ReturnValue res <span class="token operator">=</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>is<span class="token operator">&lt;</span>CppClass<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    CppClass<span class="token operator">*</span> ptr <span class="token operator">=</span> res<span class="token punctuation">.</span>as<span class="token operator">&lt;</span>CppClass<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Using ptr here is OK because</span>
    <span class="token comment">// the return value holds the handle which is still alive</span>
    <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    CppClass<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">getMyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// wren::ReturnValue has fallen out of scope at this point.</span>
    <span class="token comment">// It is not guaranteed that CppClass* ptr will be </span>
    <span class="token comment">// pointing to valid memory.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>But this is ok:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CppClass<span class="token operator">&gt;</span> <span class="token function">getMyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wren<span class="token operator">::</span>Method baz <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token string">&quot;baz()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wren<span class="token operator">::</span>ReturnValue res <span class="token operator">=</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>is<span class="token operator">&lt;</span>CppClass<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span>shared<span class="token operator">&lt;</span>CppClass<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CppClass<span class="token operator">&gt;</span> ptr <span class="token operator">=</span> <span class="token function">getMyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Instance is OK, the liveliness is controlled by this std::shared_ptr</span>
    <span class="token comment">// and by Wren at the same time. This ptr must be destroyed and Wren's </span>
    <span class="token comment">// garbage collector must take a place in order to free this instance.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p>Warning!</p> <p>The <code>wren::Variable</code>, <code>wren::Method</code>, and <code>wren::ReturnValue</code> contain handles from Wren that extend the liveness of the variables/methods they hold. You must dispose of them before the VM shuts down. Otherwise the destructor of these classes may cause undefined behavior, even a segmentation fault. Be sure that <code>wren::VM</code> is the last thing to be destroyed.</p></div> <h2 id="why-this-design"><a href="#why-this-design" aria-hidden="true" class="header-anchor">#</a> Why this design?</h2> <p>Because it keeps things simple. If you are trying to do something complex where somehow both C++ and Wren can steal instance liveness control from each other, you are probably doing something wrong. Keep things stupid simple! Avoid unexpected bugs.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/wrenbind17/assets/js/app.e6ecd826.js" defer></script><script src="/wrenbind17/assets/js/2.8d7926a2.js" defer></script><script src="/wrenbind17/assets/js/13.67b5eb9e.js" defer></script>
  </body>
</html>
