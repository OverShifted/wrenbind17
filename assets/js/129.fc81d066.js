(window.webpackJsonp=window.webpackJsonp||[]).push([[129],{313:function(t,s,a){"use strict";a.r(s);var e=a(0),n=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"liveness-and-garbage-collection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#liveness-and-garbage-collection","aria-hidden":"true"}},[t._v("#")]),t._v(" Liveness and garbage collection")]),t._v(" "),a("h2",{attrs:{id:"who-manages-the-memory"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#who-manages-the-memory","aria-hidden":"true"}},[t._v("#")]),t._v(" Who manages the memory?")]),t._v(" "),a("p",[t._v("This library is meant to be stupid simple. There is no explicit memory management, and instead it follows this formula:")]),t._v(" "),a("p",[t._v("If you create an instance of class on C++, the C++ controls the liveness of the instance. If you pass it into the Wren, it will not be freed by the garbage collector.")]),t._v(" "),a("p",[t._v("If you create an instance of class on Wren, let's say a foreign C++ class, the Wren controls the liveness of the instance. But, if you call Wren function and you will get the shared pointer of that instance, you will extend the liveness of that instance via the shared_ptr.")]),t._v(" "),a("p",[t._v("This is because all class instances are wrapped in a "),a("code",[t._v("ForeignObject<T>")]),t._v(" class and put into Wren's foreign handle. This wrapper consists of a "),a("code",[t._v("shared_ptr<T>")]),t._v(". So, every C++ instance is wrapped into "),a("code",[t._v("shared_ptr<T>")]),t._v(". But, it works in the following way:")]),t._v(" "),a("ul",[a("li",[t._v("You call Wren function and pass C++ instance as a value (no reference, no pointer). The value will be copied into a new instance and put into "),a("code",[t._v("shared_ptr<T>")]),t._v(". The copy will be freed when Wren garbage collects it. But you can extend the liveness if you get "),a("code",[t._v("shared_ptr<T>")]),t._v(" of it (by calling Wren method and returning the instance).")]),t._v(" "),a("li",[t._v("You call Wren function and pass C++ instance as a reference. The reference will be handled as a pointer, and will be put into "),a("code",[t._v("shared_ptr<T>")]),t._v(" with no deletion. It will not be deleted when Wren harbage collects this instance on Wren side.")]),t._v(" "),a("li",[t._v("You call Wren function and pass C++ instance as a pointer. Same scenario with reference, it will be put into "),a("code",[t._v("shared_ptr<T>")]),t._v(" with no deletion.")]),t._v(" "),a("li",[t._v("You call Wren function and pass C++ instance as a shared pointer. The liveness will depend on the shared pointer. No extra "),a("code",[t._v("shared_ptr<T>")]),t._v(" will be created, the wrapper will use the shared pointer you have given it.")]),t._v(" "),a("li",[t._v("You call Wren function and get the return value as a C++ instance. Then read below [Return values](#Return values) section.")])]),t._v(" "),a("h2",{attrs:{id:"how-do-i"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-do-i","aria-hidden":"true"}},[t._v("#")]),t._v(" How do I...")]),t._v(" "),a("ul",[a("li",[t._v("I want C++ to control liveness -> Pass it to Wren as a pointer or a reference.")]),t._v(" "),a("li",[t._v("I want Wren to control liveness -> Create the instance on Wren.")]),t._v(" "),a("li",[t._v("I want both C++ and Wren to control liveness -> Create the instance on Wren and return it to C++ as a shared pointer. Or create the instance on C++ and pass it to Wren as a shared pointer.")]),t._v(" "),a("li",[t._v("I want C++ to take over the liveness -> Not possible.")]),t._v(" "),a("li",[t._v("I want Wren to take over the liveness -> Not possible.")])]),t._v(" "),a("h2",{attrs:{id:"return-values"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#return-values","aria-hidden":"true"}},[t._v("#")]),t._v(" Return values")]),t._v(" "),a("p",[t._v("Everything in Wren is garbage collected, and we have no control over that on the C++ side. When you call a Wren function and return a simple type (integer, float, string, boolean, nullptr) it will automatically create a copy on C++ side inside of the "),a("code",[t._v("wren::ReturnValue")]),t._v(". You don't have to worry that an integer will get deleted or something. That would be stupid.")]),t._v(" "),a("p",[t._v("But it gets bit tricky when using C++ classes that you have manually added to Wren. When you return such class, the return value is actually a handle. This handle can be considered as a special pointer inside of Wren. If you get the class as a copy (by calling "),a("code",[t._v("as<T>()")]),t._v("), there is no problem. If you get the class as a pointer, the liveliness of the instance depends on the handle (and garbage collection). If you continue using the pointer outside of the scope of the "),a("code",[t._v("wren::ReturnValue")]),t._v(" you will definitely get into segementation fault. This can be avoided by getting the class as "),a("code",[t._v("res.shared<T>()")]),t._v(". This will give you a shared_ptr which is held inside of the Wren handle. This won't create duplicates. The instance will continue to live until the "),a("code",[t._v("wren::ReturnValue")]),t._v(" has falled out of the scope, all of the "),a("code",[t._v("shared_ptr<T>")]),t._v(" are destroyed, and the variable on Wren is garbage collected.")]),t._v(" "),a("p",[t._v("Example of what not to do:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mymodule"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" CppClass\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Foo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("baz")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" CppClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("And C++ code:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMyClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    wren"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("Method baz "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"main"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Foo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"baz()"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    wren"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("ReturnValue res "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("baz")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" ptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("as"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Using ptr here is OK because")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the return value holds the handle which is still alive")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ptr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n    CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" ptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMyClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// wren::ReturnValue has fallen out of scope at this point.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// It is not guaranteed that CppClass* ptr will be ")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pointing to valid memory.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("But this is ok:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("shared_ptr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMyClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    wren"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("Method baz "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"main"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Foo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"baz()"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    wren"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("ReturnValue res "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("baz")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shared"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n    std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("shared_ptr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CppClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" ptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMyClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Instance is OK, the liveliness is controlled by this std::shared_ptr")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// and by Wren at the same time. This ptr must be destroyed and Wren's ")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// garbage collector must take a place in order to free this instance.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"warning custom-block"},[a("p",[t._v("Warning!")]),t._v(" "),a("p",[t._v("The "),a("code",[t._v("wren::Variable")]),t._v(", "),a("code",[t._v("wren::Method")]),t._v(", and "),a("code",[t._v("wren::ReturnValue")]),t._v(" contain handles from Wren that extend the liveness of the variables/methods they hold. You must dispose of them before the VM shuts down. Otherwise the destructor of these classes may cause undefined behavior, even a segmentation fault. Be sure that "),a("code",[t._v("wren::VM")]),t._v(" is the last thing to be destroyed.")])]),t._v(" "),a("h2",{attrs:{id:"why-this-design"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#why-this-design","aria-hidden":"true"}},[t._v("#")]),t._v(" Why this design?")]),t._v(" "),a("p",[t._v("Because it keeps things simple. If you are trying to do something complex where somehow both C++ and Wren can steal instance liveness control from each other, you are probably doing something wrong. Keep things stupid simple! Avoid unexpected bugs.")])])},[],!1,null,null,null);s.default=n.exports}}]);